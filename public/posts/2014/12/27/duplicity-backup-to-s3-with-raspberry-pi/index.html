<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="After my search for a durable online backup, the conclusion was I need to encrypt my files and backup them to S3. So how do I do that? There are probably a couple of ways to do it but a search for “en">
<meta property="og:type" content="article">
<meta property="og:title" content="Duplicity Backup to S3 with Raspberry PI">
<meta property="og:url" content="http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/index.html">
<meta property="og:site_name" content="m4ktub">
<meta property="og:description" content="After my search for a durable online backup, the conclusion was I need to encrypt my files and backup them to S3. So how do I do that? There are probably a couple of ways to do it but a search for “en">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://m4ktub.ws/images/pi-aws.png">
<meta property="article:published_time" content="2014-12-27T00:00:00.000Z">
<meta property="article:modified_time" content="2015-11-05T00:00:00.000Z">
<meta property="article:author" content="Cláudio Gil">
<meta property="article:tag" content="cloud">
<meta property="article:tag" content="backup">
<meta property="article:tag" content="amazon">
<meta property="article:tag" content="s3">
<meta property="article:tag" content="rasberry-pi">
<meta property="article:tag" content="duplicity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://m4ktub.ws/images/pi-aws.png">
    
    
        
          
              <link rel="shortcut icon" href="https://www.gravatar.com/avatar/fc84e72c571a668dd413a18f92edecd7?s=16">
          
        
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/fc84e72c571a668dd413a18f92edecd7?s=192" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/fc84e72c571a668dd413a18f92edecd7?s=180">
          
        
    
    <!-- title -->
    <title>Duplicity Backup to S3 with Raspberry PI</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="m4ktub" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/2015/12/09/spell-checkers-for-hate/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/2014/11/26/durability-in-cloud-backup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&text=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&is_video=false&description=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Duplicity Backup to S3 with Raspberry PI&body=Check out this article: http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&name=Duplicity Backup to S3 with Raspberry PI&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Base-image"><span class="toc-number">1.</span> <span class="toc-text">Base image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#First-run-with-Duplicity"><span class="toc-number">2.</span> <span class="toc-text">First run with Duplicity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scripting-duplicity"><span class="toc-number">3.</span> <span class="toc-text">Scripting duplicity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scheduled-Backup"><span class="toc-number">4.</span> <span class="toc-text">Scheduled Backup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuring-Email"><span class="toc-number">5.</span> <span class="toc-text">Configuring Email</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rotating-the-Log"><span class="toc-number">6.</span> <span class="toc-text">Rotating the Log</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Real-Life"><span class="toc-number">7.</span> <span class="toc-text">Real Life</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrapping-up"><span class="toc-number">8.</span> <span class="toc-text">Wrapping up</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Duplicity Backup to S3 with Raspberry PI
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">m4ktub</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2014-12-27T00:00:00.000Z" itemprop="datePublished">2014-12-27</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/projects/">projects</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/amazon/" rel="tag">amazon</a>, <a class="tag-link" href="/tags/backup/" rel="tag">backup</a>, <a class="tag-link" href="/tags/cloud/" rel="tag">cloud</a>, <a class="tag-link" href="/tags/duplicity/" rel="tag">duplicity</a>, <a class="tag-link" href="/tags/rasberry-pi/" rel="tag">rasberry-pi</a>, <a class="tag-link" href="/tags/s3/" rel="tag">s3</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>After <a href="/posts/2014/11/26/durability-in-cloud-backup/">my search</a> for a durable online backup, the conclusion was <em>I need to
encrypt my files and backup them to S3</em>. So how do I do that? There are probably
a couple of ways to do it but a search for “encrypted backup s3”, in Google,
quickly shows results for <a href="http://duplicity.nongnu.org/" target="_blank" rel="noopener">duplicity</a>.</p>
<p>By coincidence, my <a href="http://www.raspberrypi.org/products/model-b-plus/" target="_blank" rel="noopener">Raspberry Pi B+</a> has just arrived and as it operates with
a power of <a href="http://raspi.tv/2014/how-much-less-power-does-the-raspberry-pi-b-use-than-the-old-model-b" target="_blank" rel="noopener">around 1.5 Watts</a> (with an wifi dongle) it is ideal to leave
running doing the backups. At least while I don’t need it as a media center, of
course. So lets configure a backup system with the Pi (for short), duplicity and
S3 as the storage.</p>
<h2 id="Base-image"><a href="#Base-image" class="headerlink" title="Base image"></a>Base image</h2><p>First we need to choose a base system for the Pi. If we also want a media server
to occupy the cold nights then <a href="http://www.raspbmc.com/" target="_blank" rel="noopener">Raspbmc</a> seems pretty good. Besides being a
debian and having XBCM pre-configured it has the added bonus of allowing to
pre-configure the network settings, which makes the first boot work even through
wifi.</p>
<p>We start by downloading and run the installer which then, in turn, downloads the
latest Raspbmc network image and writes it to the micro USB card. After that, we
just plug the Pi to the TV, plug it to the power and watch it boot. The first
boot takes a while but it is possible to monitor it’s progress on the TV. Just
be sure that the DVI is connected when the Pi starts because connecting the DVI
cable afterwards didn’t always work.</p>
<p>After a few restarts we get a configured XBMC. Tada! Anyway, today we’re trying
to configure a backup system so let’s move on.</p>
<h2 id="First-run-with-Duplicity"><a href="#First-run-with-Duplicity" class="headerlink" title="First run with Duplicity"></a>First run with Duplicity</h2><p>The Raspbmc system provides an SSH server and we can connect with the user “pi”
and the password “raspberry”, by default. The user “pi” is also a sudoer so
installing duplicity with support for S3 backups is rather easy.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install duplicity python-boto</span><br></pre></td></tr></table></figure>

<p>After the installation is complete we can start a backup right away. Lets create
some folders and do a first run.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir src</span><br><span class="line">$ mkdir dst</span><br><span class="line">$ duplicity src file:///dst</span><br><span class="line">Local and Remote metadata are synchronized, no sync needed.</span><br><span class="line">Last full backup date: none</span><br><span class="line">GnuPG passphrase:</span><br><span class="line">Retype passphrase to confirm:</span><br><span class="line">No signatures found, switching to full backup.</span><br><span class="line">--------------[ Backup Statistics ]--------------</span><br><span class="line">StartTime 1418687962.74 (Mon Dec 15 23:59:22 2014)</span><br><span class="line">EndTime 1418687963.02 (Mon Dec 15 23:59:23 2014)</span><br><span class="line">ElapsedTime 0.28 (0.28 seconds)</span><br><span class="line">SourceFiles 1</span><br><span class="line">SourceFileSize 4096 (4.00 KB)</span><br><span class="line">NewFiles 1</span><br><span class="line">NewFileSize 4096 (4.00 KB)</span><br><span class="line">DeletedFiles 0</span><br><span class="line">ChangedFiles 0</span><br><span class="line">ChangedFileSize 0 (0 bytes)</span><br><span class="line">ChangedDeltaSize 0 (0 bytes)</span><br><span class="line">DeltaEntries 1</span><br><span class="line">RawDeltaSize 0 (0 bytes)</span><br><span class="line">TotalDestinationSizeChange 178 (178 bytes)</span><br><span class="line">Errors 0</span><br><span class="line">-------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>We can see that, by default, duplicity asks for a password and encrypts the
files stored in the target location. In order to have an automated backup system
it needs to be non-interactive. That can achieved easily with the use of an
environment variable.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ PASSPHRASE=testing duplicity src file://dst</span><br></pre></td></tr></table></figure>

<p>Also, since duplicity uses GnuPG, the encryption is done with the CAST5 cipher
which is the default algorithm. That can be changed to AES256 by passing extra
options to GPG.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ PASSPHRASE=testing duplicity --gpg-options --cipher-algo=AES256 src file://dst</span><br></pre></td></tr></table></figure>

<p>We already installed support for the Amazon storage – with <code>python-boto</code> – so
the file destination can be changed to an S3 URL and everything works as
before. A typical S3 URL has the form
<code>s3://s3-&lt;region&gt;.amazonaws.com/&lt;bucket&gt;/&lt;path&gt;</code> but there are other forms you
can check in the <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html#access-bucket-intro" target="_blank" rel="noopener">S3 Documentation</a>. Using the S3 backend requires us to
setup the authentication and pass the Amazon’s AWS access key id and secret
key. This can be done with the <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>
environment variables.</p>
<h2 id="Scripting-duplicity"><a href="#Scripting-duplicity" class="headerlink" title="Scripting duplicity"></a>Scripting duplicity</h2><p>In order to control the amount of options a script comes in handy. Also, having
a script allows us to run the backup easily and control more aspects of the
backup. Lets start by putting the basics in a Bash script and accumulate logging
in a file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">BASEDIR=<span class="string">"<span class="variable">$(cd "$(dirname "$&#123;BASH_SOURCE[0]&#125;")</span>"</span> &amp;&amp; <span class="built_in">pwd</span>)<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SOURCE="</span>src<span class="string">"</span></span><br><span class="line"><span class="string">TARGET="</span>s3://s3-eu-west-1.amazonaws.com/backup/dst<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OPTIONS="</span><span class="variable">$OPTIONS</span> --gpg-options --cipher-algo=AES256<span class="string">"</span></span><br><span class="line"><span class="string">OPTIONS="</span><span class="variable">$OPTIONS</span> --archive-dir <span class="variable">$BASEDIR</span>/cache<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export PASSPHRASE="</span>&lt;pass&gt;<span class="string">"</span></span><br><span class="line"><span class="string">export AWS_ACCESS_KEY_ID="</span>&lt;key&gt;<span class="string">"</span></span><br><span class="line"><span class="string">export AWS_SECRET_ACCESS_KEY="</span>&lt;secret&gt;<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">duplicity <span class="variable">$OPTIONS</span> "</span><span class="variable">$SOURCE</span><span class="string">" "</span><span class="variable">$TARGET</span><span class="string">" &gt;&gt; <span class="variable">$BASEDIR</span>/duplicity.log 2&gt;&amp;1</span></span><br></pre></td></tr></table></figure>

<p>The options were expanded, for example, to specify a local cache directory with
the <code>--archive-dir</code> option. The cache directory is where duplicity keeps the
non-encrypted control files (manifest and sigtar). Keeping the cache next to the
script is a great way to keep track of progress and correct possible problems.</p>
<h2 id="Scheduled-Backup"><a href="#Scheduled-Backup" class="headerlink" title="Scheduled Backup"></a>Scheduled Backup</h2><p>Now that we have a script, a scheduled backup would be great. Cron is the
obvious choice but apparently it is not enabled by default in Raspbmc. The
easiest way to enable Cron is through the XBMC UI under <em>Programs -&gt; Raspbmc
Settings -&gt; System Configuration -&gt; Service Management -&gt; Cronjob
Scheduler</em>. After Cron is enabled we can create a file under <code>/etc/cron.d</code> with
the commands we want to schedule. Note that any file placed there will be
processed after 1 minute which means that changes and new commands will be in
effect 2 minutes later.</p>
<figure class="highlight plain"><figcaption><span>Sample cron configuration</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># min hour day  month weekday user command</span><br><span class="line">  15  21   *    *     1       pi   &#x2F;home&#x2F;pi&#x2F;backup&#x2F;duplicity.sh</span><br></pre></td></tr></table></figure>

<p>This will run the duplicity script at 9:15 PM of every Monday, that is, it will
do an incremental backup every week (after the first full backup, off
course). Any output from cron scripts are mailed to the local user and you can
use that. Nevertheless, the previous script has no output because duplicity’s
output is redirect to a log file. We we must take care of sending email
explicitly but, then again, we have more control of the email that is sent.</p>
<h2 id="Configuring-Email"><a href="#Configuring-Email" class="headerlink" title="Configuring Email"></a>Configuring Email</h2><p>The idea is to have an email, at the end of the backup, indicating if everything
happened has expected or not. That can be accomplished with the subject line
which means we can use the body of the email for the full output of the backup,
for example.</p>
<p>The first thing we need to do is install the missing software. There are a few
options but one of the simplest and most common is sSMTP.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install ssmtp mailutils</span><br></pre></td></tr></table></figure>

<p>We need to configure sSMTP to send email through some server. To use GMail, for
example, we need to change the configuration file in <code>/etc/ssmtp/ssmtp.conf</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Config file for sSMTP sendmail</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The person who gets all mail for userids &lt; 1000</span></span><br><span class="line"><span class="comment"># Make this empty to disable rewriting.</span></span><br><span class="line">root=your.account@gmail.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># The place where the mail goes. The actual machine name is required no</span></span><br><span class="line"><span class="comment"># MX records are consulted. Commonly mailhosts are named mail.domain.com</span></span><br><span class="line">mailhub=smtp.gmail.com:587</span><br><span class="line">AuthUser=your.account@gmail.com</span><br><span class="line">AuthPass=&lt;password&gt;</span><br><span class="line">UseSTARTTLS=Yes</span><br><span class="line"></span><br><span class="line"><span class="comment"># Where will the mail seem to come from?</span></span><br><span class="line"><span class="comment">#rewriteDomain=gmail.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The full hostname</span></span><br><span class="line">hostname=raspbmc</span><br><span class="line"></span><br><span class="line"><span class="comment"># Are users allowed to set their own From: address?</span></span><br><span class="line"><span class="comment"># YES - Allow the user to specify their own From: address</span></span><br><span class="line"><span class="comment"># NO - Use the system generated From: address</span></span><br><span class="line">FromLineOverride=YES</span><br></pre></td></tr></table></figure>

<p>We also need to change <code>/etc/ssmtp/revaliases</code> to give a valid address to the
local users <code>root</code> (running cron and other services) and <code>pi</code> running the backup
with duplicity (and XBMC). The revaliases file is pretty simple.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root:your.account@gmail.com:smtp.gmail.com:587</span><br><span class="line">pi:your.account@gmail.com:smtp.gmail.com:587</span><br></pre></td></tr></table></figure>

<p>There are several sources online that can help fine-tuning the configuration but
this is enough to be able to send emails. To test the configuration we can use
the <code>mail</code> command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> Hello | mail -s <span class="string">"World of Mail"</span> <span class="string">"your.account@gmail.com"</span></span><br></pre></td></tr></table></figure>

<p>If you received the email then we can change the backup script and add a mail
notification at the end of it. If the backup had no problems we include “OK” in
the subject. Otherwise we add “ERR” to make it clear that something did not work
as expected.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">BASEDIR=<span class="string">"<span class="variable">$(cd "$( dirname "$&#123;BASH_SOURCE[0]&#125;" )</span>"</span> &amp;&amp; <span class="built_in">pwd</span> )<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SOURCE="</span>src<span class="string">"</span></span><br><span class="line"><span class="string">TARGET="</span>s3://s3-eu-west-1.amazonaws.com/backup/dst<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">OPTIONS="</span><span class="variable">$OPTIONS</span> --archive-dir <span class="variable">$BASEDIR</span>/cache<span class="string">"</span></span><br><span class="line"><span class="string">OPTIONS="</span><span class="variable">$OPTIONS</span> --gpg-options --cipher-algo=AES256<span class="string">"</span></span><br><span class="line"><span class="string">OPTIONS="</span><span class="variable">$OPTIONS</span> --asynchronous-upload<span class="string">"</span></span><br><span class="line"><span class="string">OPTIONS="</span><span class="variable">$OPTIONS</span> --volsize 100<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export PASSPHRASE="</span>&lt;pass&gt;<span class="string">"</span></span><br><span class="line"><span class="string">export AWS_ACCESS_KEY_ID="</span>&lt;key&gt;<span class="string">"</span></span><br><span class="line"><span class="string">export AWS_SECRET_ACCESS_KEY="</span>&lt;secret&gt;<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">LOG=duplicity.p$$.log</span></span><br><span class="line"><span class="string">START=`date +"</span>%F %T<span class="string">"`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">duplicity <span class="variable">$OPTIONS</span> "</span><span class="variable">$SOURCE</span><span class="string">" "</span><span class="variable">$TARGET</span><span class="string">" &gt;&gt; <span class="variable">$BASEDIR</span>/<span class="variable">$LOG</span> 2&gt;&amp;1</span></span><br><span class="line"><span class="string">RESULT=$?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MAILTO=your.account@gmail.com</span></span><br><span class="line"><span class="string">MAILTAG=`(( <span class="variable">$RESULT</span> )) &amp;&amp; echo "</span>[ERR]<span class="string">" || echo "</span>[ok]<span class="string">"`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">cat <span class="variable">$LOG</span> | mail -s "</span><span class="variable">$MAILTAG</span> backup @ <span class="variable">$START</span><span class="string">" "</span><span class="variable">$MAILTO</span><span class="string">"</span></span><br><span class="line"><span class="string">cat <span class="variable">$LOG</span> &gt;&gt; <span class="variable">$BASEDIR</span>/duplicity.log</span></span><br><span class="line"><span class="string">rm -f <span class="variable">$LOG</span></span></span><br></pre></td></tr></table></figure>

<p>You can test it from the command line. To make things a little more interesting
we can increase the verbosity of the backup.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ OPTIONS=<span class="string">"-v info"</span> ./duplicity.sh</span><br></pre></td></tr></table></figure>

<p>While it is running you can see that the script creates a log file based on the
PID. At the end of it the mail is sent, that log file is added to the main log
and then removed.</p>
<h2 id="Rotating-the-Log"><a href="#Rotating-the-Log" class="headerlink" title="Rotating the Log"></a>Rotating the Log</h2><p>Although the amount of logging is small, by default, in order to be able to
leave the Rasberry Pi completely alone we still need to ensure the log does not
grow forever. Rotating the log is a matter of creating a new file under
<code>/etc/logrotate.d</code> like the following.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;pi&#x2F;backup&#x2F;duplicity.log &#123;</span><br><span class="line">  daily</span><br><span class="line">  missingok</span><br><span class="line">  rotate 2</span><br><span class="line">  minsize 1M</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can check logrotate man page and adjust the directives to our liking but
anything that ensures a constant overall size of the log files is OK.</p>
<h2 id="Real-Life"><a href="#Real-Life" class="headerlink" title="Real Life"></a>Real Life</h2><p>All of the above provides a reasonably reliable and secure backup, in theory. In
reality not everything works as expected with duplicity. </p>
<p>In my particular case the source files are in a NAS that is mounted locally
through CIFS. The NAS goes to sleep at midnight and, when the backup is still
running, duplicity fails. That was expected and should not be a problem because
duplicity has support resume a backup. Nevertheless it so happens that
version 0.6.18 (included in Rasbian Wheezy) has a bug and the restart is not so
great. For example, after a full backup of 200GB, which took a couple of days
and experienced a few restarts, the next incremental backup uploaded almost
100GB. Not a good signal, since no file was changed in the source location.</p>
<p>So, next stop, upgrade. There is a version 0.6.24 in the Raspbian repositories
under the Jessie distribution. Instead of adding the distribution to the
<code>sources.list</code> I’ve just downloaded the package and installed it directly. All
the dependencies are satisfied so no problem there. Using that new version I’ve
run a few tests just to find out that, although the restarts seem to work, this
version has another bug. When a system error is encountered duplicity does not
exit completely because a GPG process is left hanging and this forced me to kill
the process by hand.</p>
<p>This problem does not seemed known and there is not more recent package to try
so hard luck. I found <a href="https://launchpad.net/duplicity" target="_blank" rel="noopener">duplicity’s page at Launchpad</a> and checked that the
last source version (0.6.25) had no bug-fix for that error. That lead to the
creation of and account and opening bug <a href="https://bugs.launchpad.net/duplicity/+bug/1395341" target="_blank" rel="noopener">#1395341</a>. While I was exploring
Launchpad and the source code for duplicity, I decided to give it a try in
fixing the bug. After learning the basics of Bazaar and installing the required
dependencies, in a virtual machine, the bug turned out to be simple to spot and
fix. This resulted in <a href="https://bugs.launchpad.net/duplicity/+bug/1395341/+attachment/4265793/+files/duplicity-0.6.25.patch" target="_blank" rel="noopener">a patch</a>, <a href="https://code.launchpad.net/~m4ktub/duplicity/0.6-reliability" target="_blank" rel="noopener">a branch</a>, and <a href="https://code.launchpad.net/~m4ktub/duplicity/0.6-reliability/+merge/242575" target="_blank" rel="noopener">a merge proposal</a>
which, by the way, was eventually accepted and is added to both <a href="http://bazaar.launchpad.net/~duplicity-team/duplicity/0.6-series/revision/998" target="_blank" rel="noopener">0.6</a> and
<a href="http://bazaar.launchpad.net/~duplicity-team/duplicity/0.7-series/revision/1030" target="_blank" rel="noopener">0.7</a> branches. Woo hoo!</p>
<p>Looking at the packages we can see that the next Ubuntu release will include
version 0.6.23 of duplicity which means it will take a while before 0.6.26
or 0.7 are included in a stable (or event testing) Debian release. The
alternative is to download the 0.6.25 tarball, apply the patch, install the
required build tools, build duplicity from source and use the custom version by
setting <code>PATH</code> and <code>PYTHONPATH</code>. It’s actually simpler than it looked at first
despite the fact you have to bring development tools into the system.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install gcc patch librsync-dev python-dev</span><br><span class="line">... </span><br><span class="line">$ mkdir <span class="built_in">source</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="built_in">source</span></span><br><span class="line">$ wget --no-check-certificate https://launchpad.net/duplicity/0.6-series/0.6.25/+download/duplicity-0.6.25.tar.gz</span><br><span class="line">...</span><br><span class="line">$ tar -zxvf duplicity-0.6.25.tar.gz</span><br><span class="line">$ wget --no-check-certificate https://bugs.launchpad.net/duplicity/+bug/1395341/+attachment/4265793/+files/duplicity-0.6.25.patch</span><br><span class="line">...</span><br><span class="line">$ cat duplicity-0.6.25.patch | patch -d duplicity-0.6.25 -p0</span><br><span class="line">patching file duplicity/gpg.py</span><br><span class="line">$ <span class="built_in">cd</span> duplicity-0.6.25</span><br><span class="line">$ <span class="built_in">cd</span> duplicity</span><br><span class="line">$ $ python compilec.py</span><br><span class="line">running build</span><br><span class="line">running build_ext</span><br><span class="line">building <span class="string">'_librsync'</span> extension</span><br><span class="line">creating build</span><br><span class="line">creating build/temp.linux-armv6l-2.7</span><br><span class="line">gcc -pthread -fno-strict-aliasing -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -fPIC -I/usr/include/python2.7 -c _librsyncmodule.c -o build/temp.linux-armv6l-2.7/_librsyncmodule.o</span><br><span class="line">creating build/lib.linux-armv6l-2.7</span><br><span class="line">gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro build/temp.linux-armv6l-2.7/_librsyncmodule.o -lrsync -o build/lib.linux-armv6l-2.7/_librsync.so</span><br><span class="line">$ <span class="built_in">cd</span> ../..</span><br><span class="line">$ PATH=<span class="variable">$PWD</span>/duplicity-0.6.25/bin:<span class="variable">$PATH</span> PYTHONPATH=<span class="variable">$PWD</span>/duplicity-0.6.25 duplicity --version</span><br><span class="line"></span><br><span class="line">Duplicity 0.6 series is being deprecated:</span><br><span class="line">See http://www.nongnu.org/duplicity/</span><br><span class="line"></span><br><span class="line">duplicity 0.6.25</span><br></pre></td></tr></table></figure>

<p>The deprecation warning was added recently to the 0.6 branch of duplicity. You
can always try the new 0.7.x versions. Nevertheless, if you define <code>PATH</code> and
<code>PYTHONPATH</code> as above at the start of the backup script the new patched
duplicity will be used.</p>
<h2 id="Wrapping-up"><a href="#Wrapping-up" class="headerlink" title="Wrapping up"></a>Wrapping up</h2><p>Despite all the problems in the last step, it’s obvious that with duplicity we
can setup a simple, secure, and efficient backup system to the cloud. All the
tools are readily available – including the development tools – and are easy
to setup in the Raspberry Pi.</p>
<p>When you know what to do, setting up the backup from scratch would take less
than 1 hour. But then, all the testing and modifications of the script take days
or weeks. We can expand the script to allow restoring files and purging old
backups from the remote storage. We can also change the encryption to use public
key encryption and the GPG agent. The sky (or your shell script skills) is the
limit. Projects like <a href="http://duply.net/" target="_blank" rel="noopener">Duply</a>, I guess, started much in the same way and now
provides a very advanced script with a lot of extra features. It does not include
custom mail notifications, though, an relies on cron emails.</p>
<p>It all depends on your needs. If you are trying to keep things simple or totally
under your control you may want to start your script. Otherwise starting with a
powerful foundation and grow from there may be appropriate. In all cases, though,
you will need to read a bit of documentation because most configuration options
are important. In the end, we want a backup that is simple, fast, secure and,
most of all, that we can restore when we actually need it which by definition is
the worst moment possible.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Base-image"><span class="toc-number">1.</span> <span class="toc-text">Base image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#First-run-with-Duplicity"><span class="toc-number">2.</span> <span class="toc-text">First run with Duplicity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scripting-duplicity"><span class="toc-number">3.</span> <span class="toc-text">Scripting duplicity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scheduled-Backup"><span class="toc-number">4.</span> <span class="toc-text">Scheduled Backup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configuring-Email"><span class="toc-number">5.</span> <span class="toc-text">Configuring Email</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rotating-the-Log"><span class="toc-number">6.</span> <span class="toc-text">Rotating the Log</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Real-Life"><span class="toc-number">7.</span> <span class="toc-text">Real Life</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Wrapping-up"><span class="toc-number">8.</span> <span class="toc-text">Wrapping up</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&text=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&is_video=false&description=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Duplicity Backup to S3 with Raspberry PI&body=Check out this article: http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&title=Duplicity Backup to S3 with Raspberry PI" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://m4ktub.ws/posts/2014/12/27/duplicity-backup-to-s3-with-raspberry-pi/&name=Duplicity Backup to S3 with Raspberry PI&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 Cláudio Gil
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
